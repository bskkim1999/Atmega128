#define F_CPU 16000000UL
#include <avr/io.h>
#include <avr/interrupt.h>
#include <util/delay.h>
#include <stdio.h>
#include <string.h>
#include "UART0.h"

FILE OUTPUT = FDEV_SETUP_STREAM(UART0_transmit, NULL, _FDEV_SETUP_WRITE);
FILE INPUT = FDEV_SETUP_STREAM(NULL, UART0_receive, _FDEV_SETUP_READ);


volatile int count = 0;  //n번째
volatile int check = 0;
int flag_cw = 0;
int flag_ccw = 0;
//encoder(PE4)
ISR(INT4_vect){
	
	count++;  //n번째
	
	//홀수번째
	if(count % 2 == 1){
		//PIND가 0이라면?cw이다.
		if( (PIND & 0x01) == 0){
			flag_cw++;
		}
		//PIND가 1이라면?ccw이다.
		else if( (PIND & 0x01) == 1){
			flag_ccw++;
		}
	}
	
	
	//짝수번째
	else if(count % 2 == 0){
		//PIND가 1이라면?cw이다.
		if( (PIND & 0x01) == 1){
			flag_cw++;
		}
		//PIND가 0이라면?ccw이다.
		else if( (PIND & 0x01) == 0){
			flag_ccw++;
		}
		
	}
	
	
}

//interrupt (external)
void INIT_INT4(void){
	
	EIMSK = 0x10;   //external interrupt INT4(PE4)
	EICRB = 0x01;  //rising edge or falling edge
	sei();  //global interrupt(accept)
	
	
	
}

int main(void){
	
	stdout = &OUTPUT;
	stdin = &INPUT;
	
	/*variable*/
	
	
	/*uart*/
	UART0_init();
	
	/*gpio*/
	DDRE = 0x00; //input
	
	/*timer&counter*/
	
	INIT_INT4();

	
	/* Replace with your application code */
	while (1) {
		
		if(flag_cw % 2 == 0){
			flag_cw = 0;  //초기화
			printf("cw \r\n");
			
		}
		else if(flag_ccw % 2 ==0){
			flag_ccw = 0; //초기화
			printf("ccw \r\n");
		}
		
		
	}
	
	printf("finish!");
	return 0;
}
